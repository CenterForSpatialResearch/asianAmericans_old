<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Display a map with a custom style</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js"></script>
<script src="//d3js.org/d3.v5.min.js"></script>
<style>
body { margin: 0; padding: 0; 
	font-family:helvetica;
}
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
#zoom{
	position:fixed;top:0px;right:0px;
	z-index:999;
	padding:10px;
}
#center{
	position:fixed;top:15px;right:0px;
	z-index:999;
	padding:10px;
}
#colors{
	position:fixed;top:40px;right:0px;
	z-index:999;
	padding:10px;
	background-color:rgba(255,255,255,.8);
	font-size:11px;
}
#popup{
	position:fixed;top:40px;left:0px;
	z-index:999;
	padding:10px;
	background-color:rgba(255,255,255,.8);
	border:1px solid black;
	font-size:11px;
}
#title{
	position:fixed;top:0px;left:0px;
	padding:10px;
	font-size:24px;
	letter-spacing:1px;
	z-index:999;
	width:100%;
	background-color:rgba(255,255,255,1);
	
}
</style>
</head>
<body>
	<div id="title">Asian American Dot Density Map</div>
	<!-- <div id="zoom">zoom</div>
	<div id="center">center</div> -->
	<div id="colors"></div>
<div id="map">
	
</div>

<div id="popup">tract info</div>
<script>

var colors = ["#ce4dc3","#6edf53","#7642d0","#dccd37","#3f7ee8","#c0e542","#75b83b","#569d3f","#6b7acf","#72dca1","#d84d34","#df7432","#427632","#d2486e","#c88534","#2f3a70","#31679f","#e13d1b","#76a4cb","#75c3bb","#de3797","#659ff1","#659ff1"]
	
	
var nationColors = {"ACS19_5yr_B02018002":colors[0],
				"ACS19_5yr_B02018003":colors[1],
				"ACS19_5yr_B02018004":colors[2],
				"ACS19_5yr_B02018005":colors[3],
				"ACS19_5yr_B02018006":colors[4],
				"ACS19_5yr_B02018007":colors[5],
				"ACS19_5yr_B02018008":colors[6],
				"ACS19_5yr_B02018009":colors[7],
				"ACS19_5yr_B02018010":colors[8],
				"ACS19_5yr_B02018011":colors[9],
				"ACS19_5yr_B02018012":colors[10],
				"ACS19_5yr_B02018013":colors[11],
				"ACS19_5yr_B02018014":colors[12],
				"ACS19_5yr_B02018015":colors[13],
				"ACS19_5yr_B02018016":colors[14],
				"ACS19_5yr_B02018017":colors[15],
				"ACS19_5yr_B02018018":colors[16],
				"ACS19_5yr_B02018019":colors[17],
				"ACS19_5yr_B02018020":colors[18],
				"ACS19_5yr_B02018021":colors[19],
				"ACS19_5yr_B02018022":colors[20],
				"ACS19_5yr_B02018023":colors[21],
				"ACS19_5yr_B02018024":colors[22]}
	
	
var colorDictionary={"Asian Indian":"#1cabfc",
"Bangladeshi":"#00b8fe",
"Bhutanese":"#ff00b6",
"Burmese":"#ff83e1",
"Cambodian":"#fe01e8",
"Chinese, Except Taiwanese":"#fe5c50",
"Filipino":"#a502ff",
"Hmong":"#fe8c00",
"Indonesian":"#f95bff",
"Japanese":"#ff010d",
"Korean":"#ff0d7a",
"Laotian":"#ff44d0",
"Malaysian":"#ff44d0",
"Mongolian":"#ffbc5f",
"Nepalese":"#37ffd9",
"Okinawan":"#fd0f79",
"Pakistani":"#02ff74",
"Sri Lankan":"#ff7bc2",
"Taiwanese":"#ff018f",
"Thai":"#ff12eb",
"Vietnamese":"#ff01cc",
"Other Asian, Specified":"#aaaaaa",
"Other Asian, Not Specified":"#aaaaaa"}
	
var nationLabels ={"B02018002":"Asian Indian",
       "B02018003":"Bangladeshi",
       "B02018004":"Bhutanese",
       "B02018005":"Burmese",
       "B02018006":"Cambodian",
       "B02018007":"Chinese, Except Taiwanese",
       "B02018008":"Filipino",
       "B02018009":"Hmong",
       "B02018010":"Indonesian",
       "B02018011":"Japanese",
       "B02018012":"Korean",
       "B02018013":"Laotian",
       "B02018014":"Malaysian",
       "B02018015":"Mongolian",
       "B02018016":"Nepalese",
       "B02018017":"Okinawan",
       "B02018018":"Pakistani",
       "B02018019":"Sri Lankan",
       "B02018020":"Taiwanese",
       "B02018021":"Thai",
       "B02018022":"Vietnamese",
       "B02018023":"Other Asian, Specified",
       "B02018024":"Other Asian, Not Specified"}
	
	
var country = d3.csv("R12930229_SL010.csv")
var tractAsians = d3.csv("R12929173_SL140_reduced_nations.csv")
var tractTotals = d3.csv("R12931419_SL140.csv")
	
Promise.all([country,tractAsians,tractTotals])
.then(function(data){
    drawMap(data)
})



function makeTractDictionary(data){
	var dict ={}
	for(var i in data){
		//console.log(data[i])
		var key = data[i]["Geo_FIPS"]
		var values = data[i]
		dict[key]=values
	}
	return dict
}

function drawMap(data){
	var tracts = data[1]
	var tractDictionary = makeTractDictionary(tracts)
	var tractTotalsDictionary = makeTractDictionary(data[2])
	//console.log(tracts)
	mapboxgl.accessToken = 'pk.eyJ1IjoiampqaWlhMTIzIiwiYSI6ImNpbDQ0Z2s1OTN1N3R1eWtzNTVrd29lMDIifQ.gSWjNbBSpIFzDXU2X5YCiQ';
	const map = new mapboxgl.Map({
	container: 'map', // container ID
	style: 'mapbox://styles/jjjiia123/ckuoxbxs46sgg17phna2nhj4b', // custom style url from https://studio.mapbox.com/
	center: [ -73.86096055473216, 40.75430783952925], // starting position
	zoom: 10.5, // starting zoom
	maxZoom:12,
	minZoom:4//,
	//icon-allow-overlap:true
	});
	
 	map.on("load",function(){
		
    	drawKey(data[0][0],data[1])
		
		map.on("mousemove",function(e){
			var features = map.queryRenderedFeatures(e.point,{layers: ["tracts-11r8l4"]})[0];
			if(features!=null){
				var geoId = features.properties.FIPS
				//console.log(tractDictionary[geoId])
			
				  map.setPaintProperty("tracts-11r8l4", "line-color", 
 			   		['match',
							['get', 'FIPS'],
							 geoId,"#000000",
				"#aaaaaa"]
				)
			
			
				var totalAsians =tractDictionary[geoId]["ACS19_5yr_B02018001"]
				var totalPop = tractTotalsDictionary[geoId]["SE_A00001_001"]
				if(totalPop!=0){
					var percentAsians = Math.round(totalAsians/totalPop*10000)/100+"%"
					var nations = ""
					for(var n in nationLabels){
						var label = nationLabels[n]
						var value = tractDictionary[geoId]["ACS19_5yr_"+n]
						var percent = Math.round(value/totalAsians*10000)/100+"%"
						if(value!=0){
							nations+="<strong>"+label+"</strong>: "+value+"("+percent+")"+"<br>"
						}
					}
					var mouseX = e.point.x
					var mouseY = e.point.y
					d3.select("#popup").style("left",(mouseX+10)+"px")
					d3.select("#popup").style("top",mouseY+"px")
			
					d3.select("#popup").html(function(d){
					return "<strong>Tract "+geoId+"</strong><br>"+"<strong>Total Population:</strong> "+totalPop+"<br>"+"<strong>Total Asian:</strong> "+totalAsians+" ("+percentAsians+" of Total)<br><br>"+nations
				
					})
				}else{
					d3.select("#popup").html(function(d){
						return "<strong>Tract "+geoId+"</strong><br>"+"<strong>Total Population:</strong> "+totalPop+"<br>"+"<strong>Total Asian:</strong> "+totalAsians})
				
				}
			}
			
			
			
		})
		
	
		// map.on("move",function(){
	// 		d3.select("#zoom").html("zoom: "+map.getZoom())
	// 		d3.select("#center").html("center: "+map.getCenter().lng+", "+map.getCenter().lat)
	// 	})
 		// console.log("test")
		 //map.setLayoutProperty("points-nationality-9",'icon-allow-overlap', false)//: 
		
 		 var layers =  map.getStyle().layers
 		  	 for(var l =0;l<10;l++){
 		   			var layerId = "points-nationality-"+l
				 if(layerId!="mapbox-satellite"&& layerId!="background"&& layerId!="country-boundaries"){
				 //	console.log(layerId)
					 map.setPaintProperty(layerId,'circle-radius',{'base': 1,'stops': [[4,1],[5, 1],[8,.8],[11,.8],[12, .6]]})
					 map.setPaintProperty(layerId,'circle-opacity',{'base': .5,'stops': [[4, .5],[8, 1],[12, 1]]})
					  map.setPaintProperty(layerId, "circle-color", ['match',
							['get', 'nation'],
							 "ACS19_5yr_B02018002",colorDictionary[nationLabels["B02018002"]],
							"ACS19_5yr_B02018003",colorDictionary[nationLabels["B02018003"]],
							"ACS19_5yr_B02018004",colorDictionary[nationLabels["B02018004"]],
							"ACS19_5yr_B02018005",colorDictionary[nationLabels["B02018005"]],
							"ACS19_5yr_B02018006",colorDictionary[nationLabels["B02018006"]],
							"ACS19_5yr_B02018007",colorDictionary[nationLabels["B02018007"]],
							"ACS19_5yr_B02018008",colorDictionary[nationLabels["B02018008"]],
							"ACS19_5yr_B02018009",colorDictionary[nationLabels["B02018009"]],
							"ACS19_5yr_B02018010",colorDictionary[nationLabels["B02018010"]],
							"ACS19_5yr_B02018011",colorDictionary[nationLabels["B02018011"]],
							"ACS19_5yr_B02018012",colorDictionary[nationLabels["B02018012"]],
							"ACS19_5yr_B02018013",colorDictionary[nationLabels["B02018013"]],
							"ACS19_5yr_B02018014",colorDictionary[nationLabels["B02018014"]],
							"ACS19_5yr_B02018015",colorDictionary[nationLabels["B02018015"]],
							"ACS19_5yr_B02018016",colorDictionary[nationLabels["B02018016"]],
							"ACS19_5yr_B02018017",colorDictionary[nationLabels["B02018017"]],
							"ACS19_5yr_B02018018",colorDictionary[nationLabels["B02018018"]],
							"ACS19_5yr_B02018019",colorDictionary[nationLabels["B02018019"]],
							"ACS19_5yr_B02018020",colorDictionary[nationLabels["B02018020"]],
							"ACS19_5yr_B02018021",colorDictionary[nationLabels["B02018021"]],
							"ACS19_5yr_B02018022",colorDictionary[nationLabels["B02018022"]],
							"ACS19_5yr_B02018023",colorDictionary[nationLabels["B02018023"]],
							"ACS19_5yr_B02018024",colorDictionary[nationLabels["B02018024"]],
							/* other */ '#ccc']
 
  					 )
				 }
 		   		}

 	})
}
		   
function drawKey(data,tracts){
	var percentDictionary = []
	for(var n in nationLabels){
			var percent = data["PCT_ACS19_5yr_"+n]
			var value = data["ACS19_5yr_"+n]
			percentDictionary.push({nation:n,percent:percent,pop:value})
	}

		var sorted = percentDictionary.sort(function(a,b){return b.percent-a.percent})
		for(var s in sorted){
			d3.select("#colors").append("div")
				.html(nationLabels[sorted[s].nation]
				+" "+sorted[s].percent+"%")
				.style("color",colorDictionary[nationLabels[sorted[s].nation]])
				// nationColors["ACS19_5yr_"+sorted[s].nation])
				.attr("id",sorted[s].nation)
				.on("mouseover",function(){
					var nation = d3.select(this).attr("id")
				})
		}
}
		   
</script>
 
</body>
</html>